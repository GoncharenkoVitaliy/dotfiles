#!/usr/bin/env bash
# upgradeSystem.sh ‚Äî universal system updater (host or VM)
# Supports: APT, Pacman, DNF, Zypper, Flatpak, Snap, Timeshift (any distro)
# + cache cleanup + disk usage report

if [[ -t 1 ]]; then
    RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
    BLUE='\033[0;34m'; MAGENTA='\033[0;35m'; CYAN='\033[0;36m'
    BOLD='\033[1m'; RESET='\033[0m'
else
    RED=''; GREEN=''; YELLOW=''; BLUE=''; MAGENTA=''; CYAN=''; BOLD=''; RESET=''
fi

header() { echo -e "${BOLD}${MAGENTA}$*${RESET}"; }
section() { echo -e "${BOLD}${BLUE}$*${RESET}"; }
info() { echo -e "${GREEN}‚úì $*${RESET}"; }
warn() { echo -e "${YELLOW}‚ö† $*${RESET}"; }
error() { echo -e "${RED}‚úó $*${RESET}"; }

LOG_DIR="$HOME/settings/backups/update_logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/$(date +%Y%m%d_%H%M%S)_upgradeSystem.log"
exec > >(tee -a "$LOG_FILE") 2>&1

#=========================================================
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

is_timeshift_available() {
    command -v timeshift >/dev/null 2>&1 && [[ -f /etc/timeshift/timeshift.json ]]
}

backup_system() {
    if ! is_timeshift_available; then
        warn "Timeshift not configured ‚Äî skipping filesystem snapshot."
        return
    fi

    section "üìÅ Creating filesystem snapshot via Timeshift..."
    
    if ! sudo timeshift --check-config >/dev/null 2>&1; then
        warn "Timeshift config invalid ‚Äî skipping snapshot."
        return
    fi

    # Keep only 2 latest upgradeSystem snapshots
    local -a snaps
    mapfile -t snaps < <(sudo timeshift --list 2>/dev/null | grep 'upgradeSystem pre-update' | awk '{print $3}')
    if (( ${#snaps[@]} > 2 )); then
        info "Found ${#snaps[@]} old upgradeSystem snapshots ‚Äî keeping 2 latest."
        for ((i=2; i<${#snaps[@]}; i++)); do
            sudo timeshift --delete --snapshot "${snaps[$i]}" 2>/dev/null || \
                warn "Failed to delete snapshot ${snaps[$i]}"
        done
    fi

    local snap_name="upgradeSystem pre-update $(date '+%F %T')"
    if sudo timeshift --create --comments "$snap_name" --tags D --scripted; then
        info "Snapshot created: $snap_name"
    else
        warn "Timeshift snapshot failed ‚Äî continuing update."
    fi
}

report_disk_usage() {
    section "üìä Disk usage report"
    echo "Mountpoint      Size  Used Avail Use% Path"
    df -h / /home /tmp /var 2>/dev/null | grep -E '^(/|[[:space:]])' | while IFS= read -r line; do
        [[ -n "$line" ]] && echo "  $line"
    done

    echo -e "\n  Key directories:"
    for dir in /var/log /var/cache /tmp "$HOME/.cache" "$HOME/.local/share/flatpak"; do
        [[ -d "$dir" ]] && printf "  %-30s %s\n" "$dir:" "$(du -sh "$dir" 2>/dev/null | cut -f1)"
    done
}

cleanup_caches() {
    section "üßπ Cleaning caches & logs"

    # System logs
    if command -v journalctl &> /dev/null; then
        sudo journalctl --vacuum-time=14d -q 2>/dev/null || \
        sudo journalctl --vacuum-size=200M -q 2>/dev/null || true
    fi

    # Package managers
    if command -v apt &> /dev/null; then
        sudo apt clean -qq 2>/dev/null
        sudo apt autoclean -qq 2>/dev/null
    elif command -v pacman &> /dev/null; then
        sudo pacman -Sc --noconfirm 2>/dev/null || true
    elif command -v dnf &> /dev/null; then
        sudo dnf clean all -q 2>/dev/null || true
    elif command -v zypper &> /dev/null; then
        sudo zypper clean -a -q 2>/dev/null || true
    fi

    # User cache: files not accessed in 30 days
    if [[ -d "$HOME/.cache" ]]; then
        local cleaned
        cleaned=$(find "$HOME/.cache" -type f -atime +30 -delete -print 2>/dev/null | wc -l)
        info "Deleted $cleaned old cache files from ~/.cache"
    fi

    # Flatpak/Snap cleanup
    if command -v flatpak &> /dev/null; then
        flatpak uninstall --user --unused -y 2>/dev/null || true
        sudo flatpak uninstall --unused -y 2>/dev/null || true
        flatpak repair --user 2>/dev/null || true
    fi
    if command -v snap &> /dev/null; then
        sudo snap set system refresh.retain=2 2>/dev/null || true
    fi
}

#=========================================================
# –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å

header "üöÄ Starting system update..."

# 0. Disk report (before)
report_disk_usage

# 1. Filesystem snapshot (if Timeshift available)
backup_system

# --- 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è APT (Debian, Ubuntu, Pop!_OS, Mint) ---
if command -v apt-get &> /dev/null; then
    section "  Detected APT-based system (using apt-get for scripting stability)."
    
    # –¢–∏—Ö–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
    sudo apt-get update -qq
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ (–±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –∫–æ–Ω—Ñ–∏–≥–∞—Ö)
    sudo apt-get upgrade -y \
        -o Dpkg::Options::="--force-confdef" \
        -o Dpkg::Options::="--force-confold" || true
    
    # –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—É—á–∏—Ç—ã–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –∫–∞–∫ full-upgrade)
    sudo apt-get dist-upgrade -y \
        -o Dpkg::Options::="--force-confdef" \
        -o Dpkg::Options::="--force-confold" || true
    
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    sudo dpkg --configure -a || true
    
    # –û—á–∏—Å—Ç–∫–∞
    sudo apt-get autoremove -y --purge
    sudo apt-get autoclean -qq
    sudo apt-get clean -qq
    
    info "  APT packages updated (via apt-get)."
fi

# --- 3. Pacman ---
if command -v pacman &> /dev/null; then
    section "üì¶ Pacman (Arch family)"
    sudo pacman -Syu --noconfirm || warn "Core update failed."

    # AUR
    if command -v yay &> /dev/null; then
        info "‚Üí Updating AUR (yay)..."
        yay -Sua --devel --timeupdate --noconfirm 2>/dev/null || warn "AUR update failed."
    elif command -v paru &> /dev/null; then
        info "‚Üí Updating AUR (paru)..."
        paru -Sua --devel --timeupdate --noconfirm 2>/dev/null || warn "AUR update failed."
    fi

    # Orphans
    local orphans
    orphans=$(pacman -Qdtq 2>/dev/null)
    [[ -n "$orphans" ]] && { sudo pacman -Rs $orphans --noconfirm 2>/dev/null && info "Removed orphans: $orphans"; } || :
    info "Pacman update completed."
fi

# --- 4. DNF ---
if command -v dnf &> /dev/null; then
    section "üì¶ DNF (Fedora/RHEL family)"
    sudo dnf upgrade -y || true
    sudo dnf autoremove -y || true
    info "DNF update completed."
fi

# --- 5. Zypper ---
if command -v zypper &> /dev/null; then
    section "üì¶ Zypper (openSUSE)"
    sudo zypper refresh -y || true
    sudo zypper update -y || true
    info "Zypper update completed."
fi

# --- 6. Flatpak/Snap (update only; cleanup in cleanup_caches)
if command -v flatpak &> /dev/false; then :; fi  # already covered
if command -v flatpak &> /dev/null; then
    section "üì¶ Flatpak"
    flatpak update --user -y 2>/dev/null || true
    sudo flatpak update -y 2>/dev/null || true
    info "Flatpak update completed."
fi
if command -v snap &> /dev/null; then
    section "üì¶ Snap"
    sudo snap refresh 2>/dev/null || true
    info "Snap update completed."
fi

# --- 7. Final cleanup ---
cleanup_caches

# 8. Disk report (after)
report_disk_usage

header "‚úÖ System update & cleanup finished. Log: $LOG_FILE"



# sudo journalctl --vacuum-time=7d # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–ø—Ä–∏–º–µ—Ä, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞ 7 –¥–Ω–µ–π)
# sudo apt-get purge $(dpkg -l 'linux-*' | sed '/^ii/!d; /prereq/d; /rc/d' | grep -v "$(uname -r | sed 's/-generic//')" | awk '{print $2}' | xargs) # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —è–¥–µ—Ä (–û–ß–ï–ù–¨ –û–°–¢–û–†–û–ñ–ù–û)


